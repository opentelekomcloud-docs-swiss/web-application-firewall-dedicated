:original_name: waf_01_0010.html

.. _waf_01_0010:

Configuring a Precise Protection Rule
=====================================

WAF allows you to customize protection rules by combining HTTP headers, cookies, URLs, request parameters, and client IP addresses.

You can combine common HTTP fields, such as **IP**, **Path**, **Referer**, **User Agent**, and **Params** in a protection rule to let WAF allow, block, or only log the requests that match the combined conditions.

Prerequisites
-------------

A website has been added to WAF.

Application Scenarios
---------------------

Precise protection rules are used for anti-leeching and website management background protection.

Procedure
---------

#. Log in to the management console.

#. Click |image1| in the upper left corner of the management console and select a region or project.

#. Click |image2| in the upper left corner and choose **Web Application Firewall** under **Security**.

#. In the navigation pane, choose **Website Settings**.

#. In the **Policy** column of the row containing the domain name, click **Configure Policy**.

#. In the **Precise Protection** configuration area, change **Status** as needed and click **Customize Rule** to go to the **Precise Protection** page.

#. On the **Precise Protection** page, set **Detection Mode**.

   Two detection modes are available:

   -  **Instant Detection**: If a request matches a configured precise protection rule, WAF immediately ends threat detection and blocks the request.
   -  **Full Detection**: If a request matches a configured precise protection rule, WAF finishes its scan first and then blocks all requests that match the configured precise protection rule.

#. Click **Add Rule**.

#. In the displayed dialog box, add a rule by referring to :ref:`Table 1 <waf_01_0010__table2299936310457>`.

   .. important::

      To ensure that WAF blocks only attack requests, configure **Protective Action** to **Log only** first and check whether normal requests are blocked on the **Events** page. If no normal requests are blocked, configure **Protective Action** to **Block**.

   If a visitor tries to access a URL containing **/admin**, WAF will block the request.

   .. _waf_01_0010__table2299936310457:

   .. table:: **Table 1** Rule parameters

      +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------+
      | Parameter             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Example Value                                       |
      +=======================+==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+=====================================================+
      | Protective Action     | You can select **Block**, **Allow**, or **Log only**. Default value: **Block**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | **Block**                                           |
      +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------+
      | Effective Date        | Select **Immediate** to enable the rule immediately, or select **Custom** to configure when you wish the rule to be enabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | **Immediate**                                       |
      +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------+
      | Condition List        | Click **Add** to add conditions. At least one condition needs to be added. You can add up to 30 conditions to a protection rule. If more than one condition is added, all of the conditions must be met for the rule to be applied. A condition includes the following parameters:                                                                                                                                                                                                                                                                                                                                                                                                           | -  **Path** **Include** **/admin**                  |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | -  **User Agent** **Prefix is not** **mozilla/5.0** |
      |                       | Parameters for configuring a condition are described as follows:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | -  **IP** **Equal to** **192.168.2.3**              |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | -  **Cookie key1** **Prefix is not** **jsessionid** |
      |                       | -  **Field**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                                                     |
      |                       | -  **Subfield**: Configure this field only when **Params**, **Cookie**, or **Header** is selected for **Field**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                     |
      |                       | -  **Logic**: Select a logical relationship from the drop-down list.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                     |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                     |
      |                       |    .. note::                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                                                     |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                     |
      |                       |       -  If **Include any value**, **Exclude any value**, **Equal to any value**, **Not equal to any value**, **Prefix is any value**, **Prefix is not any of them**, **Suffix is any value**, or **Suffix is not any of them** is selected, select an existing reference table in the **Content** drop-down list. For details, see :ref:`Adding a Reference Table <waf_01_0081>`.                                                                                                                                                                                                                                                                                                           |                                                     |
      |                       |       -  **Exclude any value**, **Not equal to any value**, **Prefix is not any of them**, and **Suffix is not any of them** indicates, respectively, that WAF performs the protection action (block, allow, or log only) when the field in the access request does not contain, is not equal to, or the prefix or suffix is not any value set in the reference table. For example, assume that **Path** field is set to **Exclude any value** and the **test** reference table is selected. If *test1*, *test2*, and *test3* are set in the **test** reference table, WAF performs the protection action when the path of the access request does not contain *test1*, *test2*, or *test3*. |                                                     |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                     |
      |                       | -  **Content**: Enter or select the content of condition matching.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                                                     |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                     |
      |                       | .. note::                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                     |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                     |
      |                       |    For more details about the configurations in general, see :ref:`Table 2 <waf_01_0010__table13543174312394>`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                     |
      +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------+
      | Priority              | Rule priority. If you have added multiple rules, rules are matched by priority. The smaller the value you set, the higher the priority.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | **5**                                               |
      +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------+
      | Rule Description      | A brief description of the rule. This parameter is optional.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | None                                                |
      +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------+

   .. _waf_01_0010__table13543174312394:

   .. table:: **Table 2** Condition list configurations

      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | Field                                                                                                                                                                                            | Subfield        | Logic                                                  | Example Content                                                                           |
      +==================================================================================================================================================================================================+=================+========================================================+===========================================================================================+
      | **Path**: Part of a URL that does not include a domain name. This value supports exact matches only. For example, if the path to be protected is **/admin**, **Path** must be set to **/admin**. | None            | Select a logical relationship from the drop-down list. | **/buy/phone/**                                                                           |
      |                                                                                                                                                                                                  |                 |                                                        |                                                                                           |
      |                                                                                                                                                                                                  |                 |                                                        | .. important::                                                                            |
      |                                                                                                                                                                                                  |                 |                                                        |                                                                                           |
      |                                                                                                                                                                                                  |                 |                                                        |    NOTICE:                                                                                |
      |                                                                                                                                                                                                  |                 |                                                        |    If **Path** is set to **/**, all paths of the website are protected.                   |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **User Agent**: A user agent of the scanner to be checked.                                                                                                                                       | None            |                                                        | **Mozilla/5.0 (Windows NT 6.1)**                                                          |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **IP**: An IP address of the visitor for the protection.                                                                                                                                         | --              |                                                        | XXX.XXX.1.1                                                                               |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **Params**: A request parameter.                                                                                                                                                                 | -  All fields   |                                                        | **201901150929**                                                                          |
      |                                                                                                                                                                                                  | -  Any subfield |                                                        |                                                                                           |
      |                                                                                                                                                                                                  | -  Custom       |                                                        |                                                                                           |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **Referer**: A user-defined request resource.                                                                                                                                                    | --              |                                                        | http://www.test.com                                                                       |
      |                                                                                                                                                                                                  |                 |                                                        |                                                                                           |
      | For example, if the protected path is **/admin/xxx** and you do not want visitors to access the page from **www.test.com**, set **Content** to **http://www.test.com**.                          |                 |                                                        |                                                                                           |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **Cookie**: A small piece of data to identify web visitors.                                                                                                                                      | -  All fields   |                                                        | jsessionid                                                                                |
      |                                                                                                                                                                                                  | -  Any subfield |                                                        |                                                                                           |
      |                                                                                                                                                                                                  | -  Custom       |                                                        |                                                                                           |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **Header**: A user-defined HTTP header.                                                                                                                                                          | -  All fields   |                                                        | **text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8** |
      |                                                                                                                                                                                                  | -  Any subfield |                                                        |                                                                                           |
      |                                                                                                                                                                                                  | -  Custom       |                                                        |                                                                                           |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **Method**: the user-defined request method.                                                                                                                                                     | None            |                                                        | **GET**, **POST**, **PUT**, **DELETE**, and **PATCH**                                     |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **Request Line**: Length of a user-defined request line.                                                                                                                                         | None            |                                                        | **50**                                                                                    |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **Request**: Length of a user-defined request. It includes the request header, request line, and request body.                                                                                   | None            |                                                        | None                                                                                      |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+
      | **Protocol**: the protocol of the request.                                                                                                                                                       | None            |                                                        | http                                                                                      |
      +--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+--------------------------------------------------------+-------------------------------------------------------------------------------------------+

#. Click **OK**. You can then view the added precise protection rule in the protection rule list.

   -  To disable a rule, click **Disable** in the **Operation** column of the rule. The default **Rule Status** is **Enabled**.
   -  To modify a rule, click **Modify** in the row containing the rule.
   -  To delete a rule, click **Delete** in the row containing the rule.

Protection Effect
-----------------

If you have configured a precise protection rule for your domain name, to verify WAF is protecting your website (**www.example.com**) against the rule:

#. Clear the browser cache and enter the domain name in the address bar to check whether the website is accessible.

   -  If the website is inaccessible, connect the website domain name to WAF by following the instructions in :ref:`Step 1: Add a Website to WAF <waf_01_0250>`.
   -  If the website is accessible, go to :ref:`Step 2 <waf_01_0010__li1160182620213>`.

#. .. _waf_01_0010__li1160182620213:

   Clear the browser cache and enter **http://www.example.com/admin** (or any page containing **/admin**) in the address bar. Normally, WAF blocks the requests that meet the conditions and returns the block page.

#. Return to the WAF console. In the navigation pane, click **Events**. On the displayed page, view or :ref:`download events data <waf_01_0077>`.

Configuration Example - Allowing a Specified IP Address to Access Your Website
------------------------------------------------------------------------------

You can configure two precise protection rules, one to block all requests, but then another one to allow the access from a specific IP address.

.. |image1| image:: /_static/images/en-us_image_0210924450.jpg
.. |image2| image:: /_static/images/en-us_image_0000001074398929.png
